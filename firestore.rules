rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to city break packages. Only authenticated users can create, update, or delete.
     * @path /cityBreaks/{cityBreakId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /cityBreaks/{cityBreakId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Grants public read access to tour packages. Only authenticated users can create, update, or delete.
     * @path /tours/{tourId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /tours/{tourId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Grants public read access to coach ride services. Only authenticated users can create, update, or delete.
     * @path /coachRides/{coachRideId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /coachRides/{coachRideId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Grants public read access to hotels. Only authenticated users can create, update, or delete.
     * @path /hotels/{hotelId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /hotels/{hotelId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Grants public read access to flights. Only authenticated users can create, update, or delete.
     * @path /flights/{flightId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /flights/{flightId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Grants access to user profiles only to the user themselves.
     * @path /users/{userId}
     * @allow get: if isOwner(userId);
     * @allow list: if false;
     * @allow create: if isSelfCreate(userId);
     * @allow update: if isExistingOwner(userId);
     * @allow delete: if isExistingOwner(userId);
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Allow the user to read their own profile; admins can read all users
      allow get: if isOwner(userId) || isAdmin();
      // Only admins can list users
      allow list: if isAdmin();
      // Allow users to create their own profile; optionally allow admins to create
      allow create: if request.auth.uid == userId || isAdmin();
      // Allow updates/deletes by owner or admin
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }

    /**
     * @description Grants access to bookings only to the user who owns them.
     * @path /users/{userId}/bookings/{bookingId}
     * @allow get: if isBookingOwner(userId);
     * @allow list: if isBookingOwner(userId);
     * @allow create: if isBookingOwner(userId);
     * @allow update: if isExistingBookingOwner(userId);
     * @allow delete: if isExistingBookingOwner(userId);
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/bookings/{bookingId} {
      allow get: if isBookingOwner(userId);
      // Allow users to list only their own bookings within their subcollection
      allow list: if isBookingOwner(userId);
      allow create: if request.auth.uid == userId;
      allow update: if isBookingOwner(userId);
      allow delete: if isBookingOwner(userId);
    }

    /**
     * @description Collection group rules for bookings across all user paths.
     * Supports admin-wide listing via collectionGroup queries and owner-only access per document.
     * This enables queries like `collectionGroup('bookings')` for admins while preserving owner-only access otherwise.
     *
     * Note: For non-admin users performing collectionGroup queries, the query must include
     * a filter like `where('userId', '==', request.auth.uid)`, otherwise the query will be rejected
     * because rules are not filters.
     */
    match /{path=**}/bookings/{bookingId} {
      // Read access: admin can read all; owners can read their own docs
      allow get: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow list: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);

      // Create: only the owner can create their booking (validated against request.resource.data)
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Update/Delete: admin or owner
      allow update: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow delete: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
    }

    /**
     * @description Public service listings. Readable by anyone; writable only by admins.
     * @path /services/{serviceId}
     * @principle Public read, admin-only writes.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

     /**
      * @description Grants admin privileges based on the existence of a document in the roles_admin collection.
      * @path /roles_admin/{userId}
      * @allow get: if isAdmin();
      * @allow list: if false;
      * @allow create: if isAdmin();
      * @allow update: if false;
      * @allow delete: if isAdmin();
      * @principle Admin role management.
      */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if false;
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();
    }
  }

  // --- Helper functions ---

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user ID matches the authenticated user's ID.
   * @param {string} userId The user ID to check.
   * @return {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
   */
  function isOwner(userId) {
    return isSignedIn() && userId == request.auth.uid;
  }

    /**
   * @description Checks if the user is creating their own user document.
   * @param {string} userId The user ID to check.
   * @return {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
   */
  function isSelfCreate(userId) {
    return isSignedIn() && userId == request.auth.uid;
  }

  /**
   * @description Checks if the user is the owner of the existing document.
   * @param {string} userId The user ID to check.
   * @return {boolean} True if the user ID matches the authenticated user's ID and the document exists.
   */
  function isExistingOwner(userId) {
    return isOwner(userId);
  }

    /**
    * @description Checks if the user has admin privileges by checking for the existence of a document in the `/roles_admin/{userId}` collection.
    * @return {boolean} True if the user is an admin, false otherwise.
    */
    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID for bookings.
     * @param {string} userId The user ID to check.
     * @return {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isBookingOwner(userId) {
      return isSignedIn() && userId == request.auth.uid;
    }

    /**
     * @description Checks if the user is the owner of the existing booking document.
     * @param {string} userId The user ID to check.
     * @return {boolean} True if the user ID matches the authenticated user's ID and the document exists.
     */
    function isExistingBookingOwner(userId) {
      return isBookingOwner(userId);
    }
}
